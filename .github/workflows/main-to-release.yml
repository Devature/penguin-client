name: Update Release Branch

on:
  workflow_dispatch:
    inputs:
      target_commit:
        description: 'Commit hash to set release branch to (defaults to main)'
        required: false
        default: 'main'

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup GitHub CLI
        run: |
          echo "GITHUB_TOKEN=${{ secrets.ADMIN_PAT }}" >> $GITHUB_ENV
          
      - name: Update Release Branch
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          # Verify auth
          echo "Verifying authentication..."
          gh auth status
          
          # Get target commit
          TARGET_COMMIT="${{ github.event.inputs.target_commit }}"
          if [ "$TARGET_COMMIT" = "main" ]; then
            echo "Using main branch HEAD"
            TARGET_COMMIT=$(git rev-parse origin/main)
          fi
          echo "Target commit: $TARGET_COMMIT"
          
          # Update release branch using GitHub API
          echo "Updating release branch..."
          gh api \
            --method PUT \
            /repos/${GITHUB_REPOSITORY}/git/refs/heads/release \
            -f sha="$TARGET_COMMIT" \
            -f force=true
          
          echo "Release branch updated successfully"
